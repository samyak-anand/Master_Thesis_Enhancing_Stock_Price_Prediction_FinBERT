# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1hfHxSgCR1jMthHB8pM4GdXtXXkqYeOrB
"""

import yfinance as yf
import pandas as pd
from datetime import datetime

# List of tickers
tickers = [
    'TSLA', 'AAPL', 'TSM', 'AMZN', 'MSFT', 'PG', 'AMD', 'META', 'NIO', 'NFLX',
    'GOOG', 'PYPL', 'DIS', 'COST', 'KO', 'INTC', 'ENPH', 'BA', 'CRM', 'ZS',
    'XPEV', 'VZ', 'BX', 'F', 'NOC'
]

# Function to bulk download stock data
def bulk_download_stock_data(ticker_list, start_date, end_date):
    # Download all tickers' historical data at once
    print("Downloading bulk data for all tickers...")
    bulk_data = yf.download(ticker_list, start=start_date, end=end_date, group_by='ticker')

    # List to store combined data
    all_data = []

    for ticker in ticker_list:
        print(f"Processing data for {ticker}...")
        try:
            # Extract data for each ticker from the bulk dataset
            if (ticker,) in bulk_data.columns:
                stock_data = bulk_data[ticker].copy()
            else:
                print(f"No data found for {ticker}")
                continue

            # Add additional financial info
            stock_info = yf.Ticker(ticker).info
            stock_data['Ticker'] = ticker
            stock_data['Market Cap'] = stock_info.get('marketCap')
            stock_data['P/E Ratio'] = stock_info.get('trailingPE')
            stock_data['Dividend Yield'] = stock_info.get('dividendYield')
            stock_data['EPS'] = stock_info.get('trailingEps')

            # Reset index to bring Date from index to a column
            stock_data.reset_index(inplace=True)

            # Append data to the list
            all_data.append(stock_data)

        except Exception as e:
            print(f"Error processing data for {ticker}: {e}")

    # Combine all tickers' data into a single DataFrame
    combined_data = pd.concat(all_data, ignore_index=True)

    # Select relevant columns
    required_columns = ['Date', 'Open', 'High', 'Low', 'Close','Volume',
                        'Ticker', 'Market Cap', 'P/E Ratio', 'Dividend Yield', 'EPS']
    return combined_data[required_columns]

# Define the date range
start_date = '2020-01-01'
end_date = datetime.today().strftime('%Y-%m-%d')

# Download bulk data
stock_data = bulk_download_stock_data(tickers, start_date, end_date)

# Preview the data
print(stock_data.head())

# Save to CSV
output_file = 'historical_stock_data.csv'
stock_data.to_csv(output_file, index=False)
print(f"Stock data saved to '{output_file}'")

stock_data

# prompt: Using dataframe stock_data: check missing data, check data colum total count

# Check for missing data
print(stock_data.isnull().sum())

# Check data column total count
print(stock_data.count())
